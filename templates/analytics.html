<!DOCTYPE html>
<html>
<head>
    <title>Analytics - Rosemary Supermarket</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: white;
        }
        .sidebar {
            width: 260px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 0;
            z-index: 100;
        }
        .sidebar .logo {
            width: 120px;
            display: block;
            margin: 0 auto 30px;
        }
        .sidebar h3 {
            text-align: center;
            margin: 0 0 30px 0;
            font-size: 18px;
            font-weight: 600;
        }
        .sidebar a {
            display: block;
            padding: 14px 24px;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            margin: 4px 16px;
            border-radius: 10px;
            font-weight: 500;
        }
        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(4px);
        }
        .sidebar a.active {
            background: white;
            color: black;
            font-weight: 600;
        }
        .sidebar .logout {
            position: absolute;
            bottom: 20px;
            left: 16px;
            right: 16px;
            background: rgba(255, 59, 48, 0.2);
            text-align: center;
        }
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }
        h1 {
            margin-bottom: 30px;
            font-weight: 600;
        }
        .section {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(20px);
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            scroll-margin-top: 20px;
        }
        .section h2 {
            margin-top: 0;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }
        th {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px;
            color: rgba(255, 255, 255, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-box strong {
            font-size: 20px;
        }
        .stat-box p {
            color: rgba(255, 255, 255, 0.7);
            margin: 8px 0;
        }
        .no-data {
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* Small forms */
        .mini-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .mini-form input {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(0,0,0,0.25);
            color: white;
            outline: none;
        }
        .mini-form button {
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            background: white;
            color: black;
            cursor: pointer;
            font-weight: 600;
        }
        .mini-form .hint {
            opacity: 0.7;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="{{ url_for('static', filename='logo.png') }}" class="logo">
        <h3>Employee Panel</h3>
        <a href="{{ url_for('products') }}">ðŸ“¦ Products</a>
        <a href="{{ url_for('queries.analytics') }}" class="active">ðŸ“Š Analytics</a>
        <a href="{{ url_for('employee_orders.employee_orders') }}">ðŸ§¾ Orders</a>
        <a href="{{ url_for('auth.logout') }}" class="logout">Logout</a>
    </div>

    <div class="main-content">
        <h1>ðŸ“Š Analytics Dashboard</h1>

        <!-- 1 -->
        <div class="section" id="section1">
            <h2>1. All Products</h2>
            {% if all_products %}
            <table>
                <tr><th>ID</th><th>Name</th><th>Price</th><th>Barcode</th><th>Warehouse Qty</th></tr>
                {% for p in all_products %}
                <tr>
                    <td>{{ p.Product_ID }}</td>
                    <td>{{ p.Name }}</td>
                    <td>{{ "%.2f"|format(p.Price) }} â‚ª</td>
                    <td>{{ p.Barcode }}</td>
                    <td>{{ p.Quantity }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No products found</p>
            {% endif %}
        </div>

        <!-- 2 -->
        <div class="section" id="section2">
            <h2>2. All Customers</h2>
            {% if all_customers %}
            <table>
                <tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th></tr>
                {% for c in all_customers %}
                <tr><td>{{ c.Cust_ID }}</td><td>{{ c.Name }}</td><td>{{ c.Email }}</td><td>{{ c.Phone_Num }}</td></tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No customers found</p>
            {% endif %}
        </div>

        <!-- 3 -->
        <div class="section" id="section3">
            <h2>3. All Employees</h2>
            {% if all_employees %}
            <table>
                <tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th></tr>
                {% for e in all_employees %}
                <tr><td>{{ e.Emp_ID }}</td><td>{{ e.Name }}</td><td>{{ e.Email }}</td><td>{{ e.Phone_Num }}</td><td>{{ e.Address }}</td></tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No employees found</p>
            {% endif %}
        </div>

        <!-- 4 -->
        <div class="section" id="section4">
            <h2>4. Orders by Customer</h2>
            <form class="mini-form" method="get" action="{{ url_for('queries.analytics') }}#section4">
                <input type="number" name="customer_id" placeholder="Customer ID" value="{{ customer_id or '' }}">
                <button type="submit">Search</button>
                <span class="hint">Enter customer ID to show their orders</span>
            </form>

            {% if customer_orders %}
            <table>
                <tr><th>Order ID</th><th>Date</th><th>Price</th><th>Qty</th><th>Discount</th><th>Status</th></tr>
                {% for o in customer_orders %}
                <tr>
                    <td>{{ o.Order_ID }}</td>
                    <td>{{ o.Date }}</td>
                    <td>{{ "%.2f"|format(o.Price) }} â‚ª</td>
                    <td>{{ o.total_quantity }}</td>
                    <td>{{ "%.2f"|format(o.Discount) }} â‚ª</td>
                    <td>{{ o.Status }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">Enter a customer ID to view orders.</p>
            {% endif %}
        </div>

        <!-- 5 -->
        <div class="section" id="section5">
            <h2>5. Orders Handled by Employee</h2>
            <form class="mini-form" method="get" action="{{ url_for('queries.analytics') }}#section5">
                <input type="number" name="employee_id" placeholder="Employee ID" value="{{ employee_id or '' }}">
                <button type="submit">Search</button>
                <span class="hint">Enter employee ID to show orders they handled</span>
            </form>

            {% if employee_orders %}
            <table>
                <tr><th>Order ID</th><th>Date</th><th>Price</th><th>Qty</th><th>Discount</th><th>Status</th></tr>
                {% for o in employee_orders %}
                <tr>
                    <td>{{ o.Order_ID }}</td>
                    <td>{{ o.Date }}</td>
                    <td>{{ "%.2f"|format(o.Price) }} â‚ª</td>
                    <td>{{ o.total_quantity }}</td>
                    <td>{{ "%.2f"|format(o.Discount) }} â‚ª</td>
                    <td>{{ o.Status }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">Enter an employee ID to view handled orders.</p>
            {% endif %}
        </div>

        <!-- 6 -->
        <div class="section" id="section6">
            <h2>6. Total Orders Per Customer</h2>
            {% if orders_per_customer %}
            <table>
                <tr><th>Customer ID</th><th>Name</th><th>Total Orders</th></tr>
                {% for o in orders_per_customer %}
                <tr><td>{{ o.Cust_ID }}</td><td>{{ o.Name }}</td><td>{{ o.total_orders }}</td></tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No orders found</p>
            {% endif %}
        </div>

        <!-- 7 -->
        <div class="section" id="section7">
            <h2>7. Total Warehouse Value</h2>
            <div class="stat-box">
                <strong>{{ "%.2f"|format(total_warehouse_value or 0) }} â‚ª</strong>
            </div>
        </div>

        <!-- 8 -->
        <div class="section" id="section8">
            <h2>8. Products by Manufacturer</h2>
            <form class="mini-form" method="get" action="{{ url_for('queries.analytics') }}#section8">
                <input type="number" name="manufacturer_id" placeholder="Manufacturer ID" value="{{ manufacturer_id or '' }}">
                <button type="submit">Search</button>
                <span class="hint">Enter manufacturer ID to show their products</span>
            </form>

            {% if products_by_manufacturer %}
            <table>
                <tr><th>Product ID</th><th>Name</th><th>Price</th><th>Barcode</th></tr>
                {% for p in products_by_manufacturer %}
                <tr><td>{{ p.Product_ID }}</td><td>{{ p.Name }}</td><td>{{ "%.2f"|format(p.Price) }} â‚ª</td><td>{{ p.Barcode }}</td></tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">Enter a manufacturer ID to view products.</p>
            {% endif %}
        </div>

        <!-- 9 -->
        <div class="section" id="section9">
            <h2>9. Average Product Price</h2>
            <div class="stat-box">
                <strong>{{ "%.2f"|format(average_price or 0) }} â‚ª</strong>
            </div>
        </div>

        <!-- 10 -->
        <div class="section" id="section10">
            <h2>10. Customers Who Only Buy Discounted Orders</h2>
            {% if discount_only_customers %}
            <table>
                <tr>
                    <th>Customer ID</th><th>Name</th><th>Email</th>
                    <th>Total Orders</th><th>Min Discount</th>
                </tr>
                {% for c in discount_only_customers %}
                <tr>
                    <td>{{ c.Cust_ID }}</td>
                    <td>{{ c.Name }}</td>
                    <td>{{ c.Email }}</td>
                    <td>{{ c.total_orders }}</td>
                    <td>{{ "%.2f"|format(c.min_discount) }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
                <p class="no-data">No customers found where ALL orders have a discount.</p>
            {% endif %}
        </div>

        <!-- 11 -->
        <div class="section" id="section11">
            <h2>11. Available Products in Warehouse</h2>
            {% if available_products %}
            <table>
                <tr><th>Product ID</th><th>Name</th><th>Price</th><th>Quantity</th></tr>
                {% for p in available_products %}
                <tr><td>{{ p.Product_ID }}</td><td>{{ p.Name }}</td><td>{{ "%.2f"|format(p.Price) }} â‚ª</td><td>{{ p.Quantity }}</td></tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No products in warehouse</p>
            {% endif %}
        </div>

        <!-- 12 -->
        <div class="section" id="section12">
            <h2>12. Low Stock Products</h2>
            <form class="mini-form" method="get" action="{{ url_for('queries.analytics') }}#section12">
                <input type="number" name="low_stock" placeholder="Threshold" value="{{ low_stock_threshold or 10 }}">
                <button type="submit">Apply</button>
                <span class="hint">Shows products below this warehouse quantity</span>
            </form>

            {% if low_stock_products %}
            <table>
                <tr><th>Product ID</th><th>Name</th><th>Price</th><th>Quantity</th></tr>
                {% for p in low_stock_products %}
                <tr>
                    <td>{{ p.Product_ID }}</td>
                    <td>{{ p.Name }}</td>
                    <td>{{ "%.2f"|format(p.Price) }} â‚ª</td>
                    <td style="color:#ff6b6b; font-weight:700;">{{ p.Quantity }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No low stock products found (or threshold too small).</p>
            {% endif %}
        </div>

        <!-- 13 -->
        <div class="section" id="section13">
            <h2>13. Manufacturer of a Product</h2>
            <form class="mini-form" method="get" action="{{ url_for('queries.analytics') }}#section13">
                <input type="number" name="product_id" placeholder="Product ID" value="{{ product_id or '' }}">
                <button type="submit">Search</button>
                <span class="hint">Enter product ID to show its manufacturer</span>
            </form>

            {% if product_manufacturer %}
            <div class="stat-box">
                <p><strong>ID:</strong> {{ product_manufacturer.Man_ID }}</p>
                <p><strong>Name:</strong> {{ product_manufacturer.Name }}</p>
                <p><strong>Address:</strong> {{ product_manufacturer.Address }}</p>
                <p><strong>Email:</strong> {{ product_manufacturer.Email }}</p>
            </div>
            {% else %}
            <p class="no-data">Enter a product ID to view its manufacturer.</p>
            {% endif %}
        </div>

        <!-- 14 -->
        <div class="section" id="section14">
            <h2>14. Top Spending Customer</h2>
            {% if top_spending_customer %}
            <div class="stat-box">
                <p><strong>Name:</strong> {{ top_spending_customer.Name }}</p>
                <p><strong>Email:</strong> {{ top_spending_customer.Email }}</p>
                <p><strong>Total Spent:</strong> {{ "%.2f"|format(top_spending_customer.total_spent) }} â‚ª</p>
            </div>
            {% else %}
            <p class="no-data">No data available</p>
            {% endif %}
        </div>

        <!-- 15 -->
        <div class="section" id="section15">
            <h2>15. Customer with Most Orders</h2>
            {% if most_orders_customer %}
            <div class="stat-box">
                <p><strong>Name:</strong> {{ most_orders_customer.Name }}</p>
                <p><strong>Email:</strong> {{ most_orders_customer.Email }}</p>
                <p><strong>Total Orders:</strong> {{ most_orders_customer.order_count }}</p>
            </div>
            {% else %}
            <p class="no-data">No data available</p>
            {% endif %}
        </div>

        <!-- 16 -->
        <div class="section" id="section16">
            <h2>16. Most Recent Order</h2>
            {% if most_recent_order %}
            <div class="stat-box">
                <p><strong>Order ID:</strong> {{ most_recent_order.Order_ID }}</p>
                <p><strong>Customer:</strong> {{ most_recent_order.Name }}</p>
                <p><strong>Date:</strong> {{ most_recent_order.Date }}</p>
                <p><strong>Price:</strong> {{ "%.2f"|format(most_recent_order.Price) }} â‚ª</p>
            </div>
            {% else %}
            <p class="no-data">No orders found</p>
            {% endif %}
        </div>

        <!-- 17 -->
        <div class="section" id="section17">
            <h2>17. Orders in Date Range</h2>
            <form class="mini-form" method="get" action="{{ url_for('queries.analytics') }}#section17">
                <span class="hint">From</span>
                <input type="date" name="start_date" value="{{ start_date or '' }}">
                <span class="hint">To</span>
                <input type="date" name="end_date" value="{{ end_date or '' }}">
                <button type="submit">Filter</button>
            </form>

            {% if orders_in_date_range %}
            <table>
                <tr><th>Order ID</th><th>Date</th><th>Customer</th><th>Price</th><th>Qty</th><th>Status</th></tr>
                {% for o in orders_in_date_range %}
                <tr>
                    <td>{{ o.Order_ID }}</td>
                    <td>{{ o.Date }}</td>
                    <td>{{ o.customer.Name }}</td>
                    <td>{{ "%.2f"|format(o.Price) }} â‚ª</td>
                    <td>{{ o.total_quantity }}</td>
                    <td>{{ o.Status }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">Select a start/end date to show orders.</p>
            {% endif %}
        </div>

        <!-- 18 -->
        <div class="section" id="section18">
            <h2>18. Top Selling Employee</h2>
            {% if top_selling_employee %}
            <div class="stat-box">
                <p><strong>Name:</strong> {{ top_selling_employee.Name }}</p>
                <p><strong>Email:</strong> {{ top_selling_employee.Email }}</p>
                <p><strong>Total Items Sold:</strong> {{ top_selling_employee.total_sold }}</p>
            </div>
            {% else %}
            <p class="no-data">No data available</p>
            {% endif %}
        </div>

        <!-- 19 -->
        <div class="section" id="section19">
            <h2>19. Products with Manufacturers</h2>
            {% if products_with_manufacturers %}
            <table>
                <tr><th>Product ID</th><th>Product Name</th><th>Price</th><th>Manufacturer</th></tr>
                {% for p in products_with_manufacturers %}
                <tr>
                    <td>{{ p.Product_ID }}</td>
                    <td>{{ p.Name }}</td>
                    <td>{{ "%.2f"|format(p.Price) }} â‚ª</td>
                    <td>{{ p.manufacturer_name or 'N/A' }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No products found</p>
            {% endif %}
        </div>

        <!-- 20 -->
        <div class="section" id="section20">
            <h2>20. Customers Who Spent More Than Average</h2>
            {% if customers_above_avg %}
            <table>
                <tr>
                    <th>Customer ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Total Spent</th>
                </tr>
                {% for c, total in customers_above_avg %}
                <tr>
                    <td>{{ c.Cust_ID }}</td>
                    <td>{{ c.Name }}</td>
                    <td>{{ c.Email }}</td>
                    <td>{{ "%.2f"|format(total) }} â‚ª</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="no-data">No customers found above average spending.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>